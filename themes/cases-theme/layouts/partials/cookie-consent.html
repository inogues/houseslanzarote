{{- $cfg := .Site.Params.cookies -}}
{{- $key := $cfg.storage_key | default "cookieConsentV1" -}}
<div id="cookie-banner" class="cookie-banner" hidden>
  <div class="cookie-inner">
    <div class="cookie-text">
      <strong>{{ i18n "cookie_title" }}</strong>
      <p>{{ i18n "cookie_text" }}</p>
      <p class="cookie-link">
        <a href="{{ relref . "legal/politica-cookies" }}" target="_blank" rel="noopener">
          {{ i18n "cookie_policy_link" }}
        </a>
      </p>
    </div>
    <div class="cookie-actions">
      <button id="cookie-accept" class="btn-primary">{{ i18n "cookie_accept" }}</button>
      <button id="cookie-reject" class="btn-secondary">{{ i18n "cookie_reject" }}</button>
    </div>
  </div>
</div>

<script>
(function(){
  var enabled = {{ if $cfg.consent_enabled }}true{{ else }}false{{ end }};
  if(!enabled) return;

  var KEY = {{ printf "%q" $key }};
  var banner = document.getElementById('cookie-banner');
  var acceptBtn = document.getElementById('cookie-accept');
  var rejectBtn = document.getElementById('cookie-reject');

  function hasChoice(){ return localStorage.getItem(KEY) !== null; }
  function getChoice(){ return localStorage.getItem(KEY) === 'accepted'; }
  function hide(){ banner.hidden = true; banner.classList.remove('is-visible'); }
  function show(){ banner.hidden = false; requestAnimationFrame(()=>banner.classList.add('is-visible')); }

  if(!hasChoice()){ show(); }
  if(hasChoice() && getChoice() && window.__loadAnalytics){ window.__loadAnalytics(); }

  acceptBtn && acceptBtn.addEventListener('click', function(){
    localStorage.setItem(KEY, 'accepted'); hide();
    if(window.__loadAnalytics){ window.__loadAnalytics(); }
  });

  rejectBtn && rejectBtn.addEventListener('click', function(){
    localStorage.setItem(KEY, 'essential'); hide();
  });
})();
</script>