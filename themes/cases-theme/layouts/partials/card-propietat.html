<article class="card -prop">
  <a href="{{ .RelPermalink }}" class="card__link">

    {{/* COVER: 1) params.cover  2) fallback /img/{slug}-lanzarote-cover.webp  3) imatges[0] */}}
    {{- $img := "" -}}

    {{/* 1) cover explícit */}}
    {{- with .Params.cover -}}
      {{- $img = . -}}
    {{- else -}}

      {{/* 2) fallback construït */}}
      {{- $slug := "" -}}

      {{/* intentem obtenir el “slug base” del bundle o del fitxer */}}
      {{- if .File -}}
        {{- $slug = (path.Base .File.Dir) | urlize -}}
        {{- if or (eq $slug "") (eq $slug "content") -}}
          {{- $slug = .File.TranslationBaseName | urlize -}}
        {{- end -}}
      {{- end -}}
      {{- if eq $slug "" -}}
        {{- $slug = (.Slug | default .Title) | urlize -}}
      {{- end -}}

      {{/* neteja sufixos de títol per evitar “-apartment”, “-appartement”, etc. */}}
      {{- $slug = replaceRE "-(apartment|appartement|ferienwohnung|appartamento)$" "" $slug -}}

      {{/* permetre override manual si cal */}}
      {{- with .Params.cover_slug -}}
        {{- $slug = . | urlize -}}
      {{- end -}}

      {{/* afegim -lanzarote si no hi és */}}
      {{- if not (hasSuffix $slug "-lanzarote") -}}
        {{- $slug = printf "%s-%s" $slug "lanzarote" -}}
      {{- end -}}

      {{- $img = printf "/img/%s-cover.webp" $slug -}}

      {{/* 3) si encara no tenim res i hi ha galeria, fem servir la primera */}}
      {{- if not $img -}}
        {{- with .Params.imatges -}}
          {{- $img = index . 0 -}}
        {{- end -}}
      {{- end -}}

    {{- end -}}

    <div class="card__media">
      {{ with $img }}
        <img src="{{ . }}" alt="{{ $.Title }}" loading="lazy" decoding="async" style="object-fit:cover;width:100%;height:220px;">
      {{ end }}
      {{ with .Params.preu }}
        <span class="price-badge">{{ i18n "from_price" }} {{ . }}{{ $.Site.Params.currency }}{{ i18n "per_night" }}</span>
      {{ end }}
      {{ if eq (or .Params.featured false) true }}
        <span class="featured-badge"><i class="fa-solid fa-star"></i> {{ i18n "featured" }}</span>
      {{ end }}
    </div>




    <div class="card__body">
      <h3 class="card__title">{{ .Title }}</h3>
      <p class="card__meta">
        {{ with .Params.zona }}<i class="fa-solid fa-location-dot"></i> {{ delimit . ", " }}{{ end }}
        {{ if .Params.capacitat }} · <span class="meta-item"><i class="fa-solid fa-users"></i> {{ .Params.capacitat }}</span>{{ end }} {{ with .Params.habitacions }}<span class="meta-item"><i class="fa-solid fa-bed"></i> {{ . }}</span>{{ end }} {{ with .Params.banys }}<span class="meta-item break-before"><i class="fa-solid fa-bath"></i> {{ . }}</span>{{ end }}
      </p>

      {{ with .Params.summary }}<p class="card__desc">{{ . }}</p>{{ end }}

      {{/* Mini amenities amb claus canòniques, 1 sola piscina (prioritat màxima), màxim 6 */}}
      {{ $defs := site.Data.amenities }}
      {{ with .Params.amenitats }}
        {{ $keys := . }}
        {{/* separar piscines i resta */}}
        {{ $pools := slice }}{{ $others := slice }}
        {{ range $keys }}
          {{ $def := index $defs . }}
          {{ if $def }}
            {{ if eq $def.group "pool" }}
              {{ $pools = $pools | append (dict "key" . "prio" $def.priority) }}
            {{ else }}
              {{ $others = $others | append . }}
            {{ end }}
          {{ else }}
            {{ $others = $others | append . }}
          {{ end }}
        {{ end }}

        {{/* tria UNA piscina: màxima prioritat */}}
        {{ $poolKey := "" }}
        {{ if gt (len $pools) 0 }}
          {{ $sorted := sort $pools "prio" "desc" }}
          {{ $poolKey = index (index $sorted 0) "key" }}
        {{ end }}

        {{/* llista final: piscina triada + resta, fins a 6 */}}
        {{ $final := slice }}
        {{ if $poolKey }}{{ $final = $final | append $poolKey }}{{ end }}
        {{ range $others }}{{ $final = $final | append . }}{{ end }}

        <ul class="mini-amenities">
          {{ range first 6 $final }}
            {{ $def := index $defs . }}
            {{ $icon := cond $def $def.icon "fa-circle-check" }}
            {{ $labelKey := cond $def $def.label_key "" }}
            <li>
              <i class="fa-solid {{ $icon }}"></i>
              {{ if $labelKey }}{{ i18n $labelKey }}{{ else }}{{ . }}{{ end }}
            </li>
          {{ end }}
        </ul>
      {{ end }}
      <span class="btn-inline">{{ i18n "view_details" }}</span>
    </div>
  </a>
</article>

