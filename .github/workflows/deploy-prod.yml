name: Deploy Production (AWS S3 + CloudFront)

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    env:
      PROD_BUCKET: ${{ vars.PROD_BUCKET }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}
      CF_DIST_ID_PROD: ${{ secrets.CF_DIST_ID_PROD }}

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: '0.146.0'
          extended: true

      - name: Build Hugo (production)
        run: |
          rm -f static/robots.txt || true
          hugo --minify --gc --enableGitInfo --cleanDestinationDir \
               -e production \
               --baseURL "https://housesinlanzarote.eu/"

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # HTML: cache curt
      - name: Sync HTML (short cache)
        run: |
          aws s3 sync ./public s3://${{ env.PROD_BUCKET }} \
            --delete --exact-timestamps \
            --exclude "*" --include "*.html" \
            --cache-control "no-cache, no-store, must-revalidate"

      # Assets: cache llarg
      - name: Sync assets (long cache)
        run: |
          aws s3 sync ./public s3://${{ env.PROD_BUCKET }} \
            --delete --exact-timestamps \
            --exclude "*.html" \
            --cache-control "public, max-age=31536000, immutable"

      - name: Invalidate CloudFront
        if: ${{ env.CF_DIST_ID_PROD != '' }}
        run: |
          aws cloudfront create-invalidation \
            --distribution-id "${{ env.CF_DIST_ID_PROD }}" \
            --paths "/*"